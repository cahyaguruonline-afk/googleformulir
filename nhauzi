// =======================================================================
// KONFIGURASI: Ganti dengan ID Formulir Google Anda yang sebenarnya
// =======================================================================
// Pastikan ID ini benar dan akun Anda memiliki izin akses ke Formulir tersebut
const FORM_ID = '1Ks1CoCu9USj1siYAfiRj-YYR0RWuN8C5yM2X38xKRj0';Â 


/**
 * Fungsi ini membuka tautan (URL) di tab atau jendela baru browser pengguna.
 */
function openGoogleFormLink() {
  var html = HtmlService.createHtmlOutput('<script>window.open("https://docs.google.com/forms/d/1Ks1CoCu9USj1siYAfiRj-YYR0RWuN8C5yM2X38xKRj0/edit", "_blank");</script>')
      .setWidth(100)
      .setHeight(1);
  SpreadsheetApp.getUi().showModalDialog(html, 'Membuka Tautan...');
}

/**
 * Menghapus SEMUA respons dari Google Formulir.
 */

/**
 * Mengakses objek Google Formulir.
 * @returns {GoogleAppsScript.Forms.Form} Objek Formulir.
 */
function getForm() {
  try {
    const form = FormApp.openById(FORM_ID);
    return form;
  } catch (e) {
    Logger.log("Error membuka formulir: " + e.toString());
    throw new Error("Gagal membuka formulir. Pastikan ID formulir benar dan Anda memiliki izin akses.");
  }
}

function hapusSemuaRespons() {
  const form = getForm();
  
  // Metode untuk menghapus semua tanggapan
  form.deleteAllResponses(); 
  
  Logger.log(`Semua respons (${form.getResponses().length}) dari formulir "${form.getTitle()}" telah dihapus.`);
}


/**
 * Menghapus semua data di Sheet bernama "respon" mulai dari Baris ke-2
 */
function hapusDataSheetRespon() {
  
  // 1. Dapatkan Spreadsheet aktif
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // 2. Tentukan nama Sheet yang ditargetkan
  const sheetName = "respon";
  
  // Ambil objek Sheet
  const sheet = ss.getSheetByName(sheetName);
  
  // Pastikan Sheet ditemukan
  if (!sheet) {
    Logger.log(`ERROR: Sheet dengan nama "${sheetName}" tidak ditemukan. Cek kembali nama sheet Anda.`);
    Browser.msgBox(`ERROR: Sheet dengan nama "${sheetName}" tidak ditemukan.`);
    return; // Hentikan eksekusi
  }
  
  // 3. Tentukan batas baris
  const BARIS_AWAL_UNTUK_HAPUS = 2; // Kita ingin mulai menghapus dari baris ke-2
  
  // Dapatkan jumlah total baris yang berisi data
  const lastRow = sheet.getLastRow();
  
  // Hitung jumlah baris yang akan dihapus
  // Jika lastRow = 1 (hanya header), maka numRowsToDelete = 0.
  // Jika lastRow = 5, maka numRowsToDelete = 5 - 2 + 1 = 4 baris (baris 2, 3, 4, 5).
  const numRowsToDelete = lastRow - BARIS_AWAL_UNTUK_HAPUS + 1;
  
  // 4. Periksa apakah ada baris data yang perlu dihapus
  if (numRowsToDelete > 0) {
    
    // Perintah utama: Menghapus baris
    // Syntax: sheet.deleteRows(rowPosition, numRows)
    sheet.deleteRows(BARIS_AWAL_UNTUK_HAPUS, numRowsToDelete);
    
    Logger.log(`Berhasil: ${numRowsToDelete} baris data telah dihapus dari Sheet "${sheetName}", mulai dari baris ${BARIS_AWAL_UNTUK_HAPUS}.`);
    Browser.msgBox("Penghapusan Data", `Berhasil menghapus ${numRowsToDelete} baris data dari Sheet "${sheetName}".`, Browser.Buttons.OK);
    
  } else {
    
    Logger.log("Tidak ada baris data yang perlu dihapus (hanya baris header).");
    Browser.msgBox("Penghapusan Data", "Tidak ada baris data di Sheet \"respon\" yang perlu dihapus (hanya baris header yang ada).", Browser.Buttons.OK);
    
  }
}

/**
 * Fungsi ini berjalan secara otomatis saat spreadsheet dibuka.
 * Tugasnya adalah membuat menu kustom interaktif.
 */
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('ðŸ§¾ Formulir') // Nama menu utama
      .addItem('Update Formulir (Konfirmasi)', 'showConfirmationDialog') // Memanggil dialog konfirmasi
      .addItem('Buka Formulir (Konfirmasi)', 'openGoogleFormLink') // Memanggil dialog konfirmasi
      .addItem('Hapus Respon GForm (Konfirmasi)', 'hapusSemuaRespons') // Memanggil dialog konfirmasi
      .addItem('Hapus Respon Sheet (Konfirmasi)', 'hapusDataSheetRespon') // Memanggil dialog konfirmasi
      .addToUi();
}

/**
 * Menampilkan dialog konfirmasi sebelum menjalankan skrip utama.
 */
function showConfirmationDialog() {
  var ui = SpreadsheetApp.getUi();
  var result = ui.alert(
     'Konfirmasi Update Formulir',
     'Apakah Anda yakin ingin MENGHAPUS SEMUA pertanyaan di Formulir Google (' + FORM_ID + ') dan membuatnya ulang dari Sheet1?',
     ui.ButtonSet.YES_NO
  );
  
  // Periksa respon pengguna
  if (result == ui.Button.YES) {
    // Jika user menekan 'Ya', jalankan fungsi utama
    updateFormWithMixedTypes();
    ui.alert('Update Formulir Selesai!', 'Formulir telah berhasil diperbarui.', ui.ButtonSet.OK);
  } else {
    // Jika user menekan 'Tidak'
    Logger.log('Update dibatalkan oleh pengguna.');
  }
}


/**
Â * Fungsi utama untuk membaca data dari Google Sheet (Sheet1),Â 
Â * mengacak pilihan, dan MENGUPDATE Form Google yang sudah ada.
Â * Kolom H = Poin Pertanyaan (Indeks 7).
Â * Kolom I = Judul Section Berikutnya (Indeks 8).
Â */
function updateFormWithMixedTypes() {Â 
Â  Logger.log("--- Mulai Update Form dengan Poin dan Section Dinamis ---");
Â Â 
Â  // --- 1. MENGAMBIL DATA DARI SHEET ---
Â  var ss = SpreadsheetApp.getActive();
Â  var sheet = ss.getSheetByName('Sheet1');
Â Â 
Â  if (!sheet) {
Â  Â  Logger.log("ERROR: Sheet bernama 'Sheet1' tidak ditemukan! Harap periksa nama sheet.");
Â  Â  return;
Â  }
Â Â 
Â  var numberRows = sheet.getLastRow();
Â  if (numberRows <= 1) {Â 
Â  Â  Logger.log("ERROR: Sheet tidak memiliki data yang cukup (minimal 2 baris data).");
Â  Â  return;
Â  }

Â  // Mengambil 9 Kolom (Kolom A-I)
Â  var allData = sheet.getRange(1, 1, numberRows, 9).getValues();Â  
Â  var totalRows = allData.length;

Â  // --- 2. MEMBUKA DAN MEMBERSIHKAN FORMULIR ---
Â  try {
Â  Â  var form = FormApp.openById(FORM_ID);
Â  Â Â 
Â  Â  // Menghapus semua item/pertanyaan yang sudah ada
Â  Â  var items = form.getItems();
Â  Â  for (var i = items.length - 1; i >= 0; i--) {Â 
Â  Â  Â  form.deleteItem(items[i]);
Â  Â  }
Â  Â  Logger.log("Semua item lama berhasil dihapus.");
Â  Â Â 
Â  Â  // Mengatur formulir menjadi mode Kuis
Â  Â  form.setIsQuiz(true);Â 
Â  Â Â 
Â  } catch (e) {
Â  Â  Logger.log("ERROR KRITIS saat membuka/menghapus item Form: " + e.toString() + ". Pastikan ID dan izin benar.");
Â  Â  return;
Â  }

Â  // --- 3. ITERASI DAN MENAMBAHKAN ITEM BARU DENGAN SECTION ---
Â  for (var i = 0; i < totalRows; i++) {
Â  Â  var row = allData[i];
Â  Â  var questionType = row[0].toString().toUpperCase().trim(); // Kolom A: Jenis Soal
Â  Â  
Â  Â  // Bersihkan dan validasi Judul Pertanyaan
Â  Â  var cleanTitle = row[1] ? row[1].toString().trim() : "";Â  // Kolom B: Judul Pertanyaan

Â  Â  if (cleanTitle === "") {
Â  Â  Â  Â  Logger.log("Baris " + (i + 1) + " dilewati karena judul pertanyaan kosong.");
Â  Â  Â  Â  continue;Â 
Â  Â  }
Â  Â Â 
Â  Â  row[1] = cleanTitle;Â 

Â  Â  // Panggil fungsi pembantu untuk menambahkan pertanyaan berdasarkan jenis
Â  Â  switch (questionType) {
Â  Â  Â  case 'PG':
Â  Â  Â  Â  addMultipleChoiceItem(form, row);
Â  Â  Â  Â  break;
Â  Â  Â  case 'DD':Â 
Â  Â  Â  Â  addDropdownItem(form, row);
Â  Â  Â  Â  break;
Â  Â  Â  case 'IS':
Â  Â  Â  Â  addShortAnswerItem(form, row);
Â  Â  Â  Â  break;
Â  Â  Â  case 'ESAI':
Â  Â  Â  Â  addParagraphItem(form, row);Â 
Â  Â  Â  Â  break;
Â  Â  Â  case 'NAMA':Â 
Â  Â  Â  Â  addNameDropdown(form, row);
Â  Â  Â  Â  break;
Â  Â  Â  default:
Â  Â  Â  Â  Logger.log("Jenis pertanyaan tidak dikenal di baris " + (i + 1) + ": " + questionType + ". Dilewati.");
Â  Â  }
Â  Â  
Â  Â  // =======================================================
Â  Â  // LOGIKA TAMBAHAN: Tambahkan Page Break (Section Baru)
Â  Â  // Judul Section diambil dari Kolom I (Indeks 8) dari baris berikutnya
Â  Â  // =======================================================
Â  Â  if (i < totalRows - 1) { 
Â  Â  Â  var nextSectionTitle = allData[i+1][8].toString().trim(); // Kolom I (Indeks 8)
Â  Â  Â  
Â  Â  Â  // Fallback jika kolom Judul Section kosong
Â  Â  Â  if (nextSectionTitle === "") {
Â  Â  Â  Â  nextSectionTitle = "Lanjut ke Pertanyaan " + (i + 2);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  form.addPageBreakItem()
Â  Â  Â  Â  .setTitle(nextSectionTitle); 
Â  Â  }
Â  }
Â Â 
Â  Logger.log("--- Update Formulir Selesai ---");
Â  // CATATAN: Pesan sukses sekarang ditampilkan oleh showConfirmationDialog()
}


// =======================================================================
// FUNGSI PEMBANTU (HELPER FUNCTIONS)
// Poin Pertanyaan diambil dari Kolom H (Indeks 7)
// =======================================================================

/**
Â * Menambahkan item Pilihan Ganda (Multiple Choice). (PG)
Â */
function addMultipleChoiceItem(form, row) {
Â  var questionTitle = row[1];Â 
Â  var myAnswers = row[2];Â 
Â  var myGuesses = row.slice(2, 7);
Â  var questionPoint = parseInt(row[7], 10) || 1; // Kolom H (Indeks 7)

Â  var shuffledOptions = shuffleArray(myGuesses);
Â Â 
Â  var addItem = form.addMultipleChoiceItem();
Â  var choices = createChoices(addItem, shuffledOptions, myAnswers);
Â Â 
Â  addItem.setTitle(questionTitle)
Â  Â  Â  Â  Â .setPoints(questionPoint)
Â  Â  Â  Â  Â .setChoices(choices);
}

/**
Â * Menambahkan item Dropdown (List). (DD)
Â */
function addDropdownItem(form, row) {
Â  var questionTitle = row[1];Â 
Â  var myAnswers = row[2];Â 
Â  var myGuesses = row.slice(2, 7);

Â  var shuffledOptions = shuffleArray(myGuesses);
Â Â 
Â  var addItem = form.addListItem();
Â  var choices = createChoices(addItem, shuffledOptions, myAnswers);

Â  addItem.setTitle(questionTitle)

}

/**
Â * Menambahkan item Isian Singkat (Short Answer/Text). (IS)
Â */
function addShortAnswerItem(form, row) {
Â  var questionTitle = row[1];Â 
Â  var correctAnswer = row[2].toString().trim();


Â  var addItem = form.addTextItem();
Â  addItem.setTitle(questionTitle)
Â  Â  Â  Â  Â 
Â  if (correctAnswer !== "") {
Â  Â  addItem.setValidation(
Â  Â  Â  FormApp.createTextValidation()
Â  Â  Â  Â  .requireTextIsEqualTo(correctAnswer)
Â  Â  Â  Â  .build()
Â  Â  );
Â  Â  var feedback = FormApp.createFeedback().setText('Jawaban yang benar adalah: ' + correctAnswer).build();
Â  Â  addItem.setCorrectFeedback(feedback)
Â  Â  Â  Â  Â  Â .setIncorrectFeedback(feedback);
Â  }
}

/**
Â * Menambahkan item Paragraf (Paragraph/Esai). (ESAI)
Â */
function addParagraphItem(form, row) {
Â  var questionTitle = row[1];Â 
Â  // Item esai tidak secara otomatis diberi poin di sini (Poin default 0)
Â  var addItem = form.addParagraphTextItem();
Â  addItem.setTitle(questionTitle);
}

/**
Â * Menambahkan item Dropdown untuk Pilihan Nama. (NAMA)
Â * Poin 0 dan tanpa Kunci Jawaban.
Â */
function addNameDropdown(form, row) {
Â  var questionTitle = row[1];
Â  // Ambil pilihan dari Kolom C sampai G
Â  var nameOptions = row.slice(2, 7);Â 
Â Â 
Â  var addItem = form.addListItem();
Â  var choices = [];

Â  for (var j = 0; j < nameOptions.length; j++) {
Â  Â  var optionValue = nameOptions[j].toString().trim();
Â  Â Â 
Â  Â  if (optionValue !== "") {
Â  Â  Â  Â  // Tidak ada parameter 'isCorrect' (true/false) = Tidak ada kunci jawaban
Â  Â  Â  Â  choices.push(
Â  Â  Â  Â  Â  Â  addItem.createChoice(optionValue)
Â  Â  Â  Â  );
Â  Â  }
Â  }
Â Â 
Â  addItem.setTitle(questionTitle)
Â  Â  Â  Â  Â .setPoints(0) // Poin disetel 0
Â  Â  Â  Â  Â .setChoices(choices)
Â  Â  Â  Â  Â .setRequired(true);Â 
}

/**
Â * Fungsi untuk membuat array Choices untuk PG atau DD.
Â */
function createChoices(item, shuffledOptions, myAnswers) {
Â  Â  var choices = [];
Â  Â  var correctIndex = shuffledOptions.indexOf(myAnswers);

Â  Â  for (var j = 0; j < shuffledOptions.length; j++) {
Â  Â  Â  Â  var isCorrect = (j === correctIndex);
Â  Â  Â  Â  var optionValue = shuffledOptions[j].toString().trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (optionValue !== "") {
Â  Â  Â  Â  Â  Â  choices.push(
Â  Â  Â  Â  Â  Â  Â  Â  item.createChoice(optionValue, isCorrect)
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return choices;
}

/**
Â * Mengacak elemen dalam array (Algoritma Fisher-Yates).
Â */
function shuffleArray(array) {
Â  var i, j, temp;
Â  for (i = array.length - 1; i > 0; i--) {
Â  Â  j = Math.floor(Math.random() * (i + 1));
Â  Â  temp = array[i];
Â  Â  array[i] = array[j];
Â  Â  array[j] = temp;
Â  }
Â  return array;
}
